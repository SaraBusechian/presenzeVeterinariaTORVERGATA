<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Presenze (Cloud Sync)</title>
    <!-- Caricamento di Tailwind CSS per lo stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile per un'interfaccia pulita */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overscroll-behavior: none; /* Impedisce il "bounce" su mobile */
        }
        
        /* Stile per gli elementi degli studenti */
        .student-item {
            -webkit-tap-highlight-color: transparent; /* Rimuove il flash blu al tocco su mobile */
            transition: all 0.15s ease-in-out;
            border: 1px solid #d1d5db; /* Bordo grigio */
            background-color: #ffffff; /* Sfondo bianco */
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            text-align: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .student-item:hover {
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }

        /* Il bug @apply è stato risolto applicando le classi via JS */

        /* Stile per il backdrop del modal (per accessibilità) */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Stile per indicatore di stato connessione */
        #connectionStatus {
            transition: all 0.5s ease;
        }

        /* Stile per l'overlay di caricamento */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #f3f4f6; /* grigio chiaro */
            border-top-color: #3b82f6; /* blu */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- Overlay di Caricamento Iniziale -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        
        <!-- Intestazione -->
        <header id="appHeader" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Registro Presenze</h1>
                    <p class="text-gray-600">Corso di Laurea in Medicina Veterinaria - Tor Vergata</p>
                </div>
                <!-- Indicatore di Stato Connessione -->
                <div id="connectionStatus" class="flex-shrink-0 flex items-center gap-2 bg-gray-100 text-gray-500 text-sm py-1 px-3 rounded-full">
                    <div id="statusDot" class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                    <span id="statusText">Connessione...</span>
                </div>
            </div>
            
            <!-- Campi Info Uscita -->
            <div class="mt-6 border-t pt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700">Insegnamento</label>
                    <input type="text" id="subject" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="outingDate" class="block text-sm font-medium text-gray-700">Data Uscita</label>
                    <input type="date" id="outingDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="outingType" class="block text-sm font-medium text-gray-700">Tipo Uscita (es. Stalla)</label>
                    <input type="text" id="outingType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </header>

        <!-- Pannello di Controllo -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <!-- Barra di Ricerca -->
            <input type="search" id="searchBar" placeholder="Cerca uno studente..." class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <!-- Contatore -->
            <div id="counter" class="text-lg font-semibold my-4 text-center text-gray-700">
                Presenti: 0 / 16
            </div>

            <!-- Pulsanti di Azione -->
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="exportButton" class="w-full sm:w-1/2 bg-blue-600 text-white py-3 px-4 rounded-lg shadow font-semibold hover:bg-blue-700 transition duration-200">
                    Esporta / Condividi
                </button>
                <button id="resetButton" class="w-full sm:w-1/2 bg-red-600 text-white py-3 px-4 rounded-lg shadow font-semibold hover:bg-red-700 transition duration-200">
                    Azzera Lista
                </button>
            </div>
        </div>

        <!-- Lista Studenti -->
        <main>
            <div id="studentGridContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- Gli studenti verranno caricati qui da JavaScript -->
            </div>
        </main>
    </div>

    <!-- Modale per Esportazione (Fallback per Desktop) / Conferma Reset -->
    <dialog id="modal" class="p-0 rounded-lg shadow-xl max-w-lg w-11/12">
        <div class="p-6">
            <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
            
            <!-- Contenuto per Esportazione (Fallback) -->
            <div id="exportContent">
                <p class="text-sm text-gray-600 mb-3">Copia e incolla questo testo in un'email, note o documento.</p>
                <textarea id="exportTextArea" readonly class="w-full h-48 p-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"></textarea>
                <button id="copyButton" class="mt-3 w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">Copia Testo</button>
            </div>
            
            <!-- Contenuto per Reset -->
            <div id="resetContent" class="hidden">
                <p class="text-gray-700">Sei sicuro di voler azzerare le presenze **solo per questo giorno**? Le informazioni (Insegnamento, Tipo) non verranno toccate.</p>
                <button id="confirmResetButton" class="mt-4 w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">Sì, Azzera Presenze</button>
            </div>
        </div>
        
        <!-- Pulsante di Chiusura Modale -->
        <footer class="bg-gray-100 p-4 text-right">
            <button id="closeModalButton" class="bg-gray-200 text-gray-800 py-2 px-5 rounded-lg hover:bg-gray-300">Chiudi</button>
        </footer>
    </dialog>


    <!-- Script per Firebase -->
    <script type="module">
        // Importa le funzioni necessarie dai moduli Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAZIONE ---
        
        // Questa è la lista fittizia. Sostituiscila con quella reale.
        // Assicurati che ogni studente abbia un 'id' unico (es. 's1', 's2', ... o meglio ancora la matricola).
        const students = [
            { id: 's1', name: 'Mario Rossi' },
            { id: 's2', name: 'Laura Bianchi' },
            { id: 's3', name: 'Giuseppe Verdi' },
            { id: 's4', name: 'Anna Neri' },
            { id: 's5', name: 'Luca Gialli' },
            { id: 's6', name: 'Chiara Bruno' },
            { id: 's7', name: 'Paolo Russo' },
            { id: 's8', name: 'Sara Ferrari' },
            { id: 's9', name: 'Matteo Romano' },
            { id: 's10', name: 'Elena Greco' },
            { id: 's11', name: 'Davide Galli' },
            { id: 's12', name: 'Sofia Conti' },
            { id: 's13', name: 'Lorenzo Serra' },
            { id: 's14', name: 'Giulia Esposito' },
            { id: 's15', name: 'Andrea Moretti' },
            { id: 's16', name: 'Francesca Barbieri' }
        ];

        // --- CONFIGURAZIONE FIREBASE ---
        // Configurazione Firebase (inserita da te)
        const firebaseConfig = {
          apiKey: "AIzaSyAYgvLPFt9ZtfvnnwSebotXMbazOb-BcUs",
          authDomain: "presenze-pratiche-incampo-vet.firebaseapp.com",
          projectId: "presenze-pratiche-incampo-vet",
          storageBucket: "presenze-pratiche-incampo-vet.firebasestorage.app",
          messagingSenderId: "30237331152",
          appId: "1:30237331152:web:57d036de59d78108c198d5"
        };
        
        // Nome della collezione in Firestore (deve corrispondere alle Regole)
        const COLLECTION_NAME = "zootecnia_outings";


        // --- Variabili Globali ---
        let db; 
        let auth;
        let currentOutingDocRef; // Riferimento dinamico al documento dell'uscita
        let currentOutingData = {}; // Stato locale (aggiornato da Firestore)
        let unsubscribeFirestore; // Funzione per staccare il listener
        let isUpdating = false; // Flag per prevenire doppi clic
        let metadataSaveTimer; // Timer per salvare i metadata


        // --- Elementi del DOM ---
        const studentGridContainer = document.getElementById('studentGridContainer');
        const searchBar = document.getElementById('searchBar');
        const counter = document.getElementById('counter');
        const exportButton = document.getElementById('exportButton');
        const resetButton = document.getElementById('resetButton');
        
        // Header
        const connectionStatus = document.getElementById('connectionStatus');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const subjectInput = document.getElementById('subject');
        const dateInput = document.getElementById('outingDate');
        const outingTypeInput = document.getElementById('outingType');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Modale
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const exportContent = document.getElementById('exportContent');
        const exportTextArea = document.getElementById('exportTextArea');
        const copyButton = document.getElementById('copyButton');
        const resetContent = document.getElementById('resetContent');
        const confirmResetButton = document.getElementById('confirmResetButton');
        const closeModalButton = document.getElementById('closeModalButton');


        // --- Funzioni Principali ---

        /**
         * (FIX) Aggiorna solo gli stili (presente/assente) degli elementi
         * e il contatore, senza ricreare il DOM.
         */
        function updateVisuals(data = {}) {
            currentOutingData = data; // Aggiorna lo stato globale

            const attendance = currentOutingData.attendance || {};
            let presentCount = 0;
            
            // Aggiorna i campi metadata nell'header
            // Controlla che il focus non sia su questi campi prima di aggiornare
            if (document.activeElement !== subjectInput) {
                subjectInput.value = currentOutingData.subject || '';
            }
            if (document.activeElement !== outingTypeInput) {
                outingTypeInput.value = currentOutingData.outingType || '';
            }

            // Itera su tutti gli elementi studente *già presenti* nel DOM
            const studentItems = studentGridContainer.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const id = item.dataset.id;
                const isPresent = attendance[id] === true;
                
                // (FIX) Applica o rimuovi le classi Tailwind direttamente
                item.classList.toggle('text-gray-500', isPresent);
                item.classList.toggle('line-through', isPresent);
                item.classList.toggle('opacity-75', isPresent);
                item.classList.toggle('bg-gray-50', isPresent);
                item.classList.toggle('border-gray-200', isPresent);

                // Stili per "assente" (default)
                item.classList.toggle('text-gray-900', !isPresent);
                item.classList.toggle('bg-white', !isPresent);
                item.classList.toggle('border-gray-300', !isPresent);

                if (isPresent) {
                    presentCount++;
                }
            });

            // Aggiorna il contatore
            counter.textContent = `Presenti: ${presentCount} / ${students.length}`;
        }
        
        /**
         * (FIX) Filtra la lista (mostra/nasconde) in base alla ricerca.
         * Non ricrea il DOM.
         */
        function filterList() {
            const normalizedFilter = searchBar.value.trim().toLowerCase();
            const studentItems = studentGridContainer.querySelectorAll('.student-item');

            studentItems.forEach(item => {
                const name = item.textContent.toLowerCase();
                const isMatch = name.includes(normalizedFilter);
                // Nasconde o mostra l'elemento
                item.style.display = isMatch ? 'block' : 'none';
            });
        }


        /**
         * Si collega a un documento specifico in Firestore in base alla data.
         * @param {string} docId - La data (es. "2025-11-15")
         */
        function attachFirestoreListener(docId) {
            // Se c'è un listener precedente, stacccalo per evitare ascolti multipli
            if (unsubscribeFirestore) {
                unsubscribeFirestore();
            }
            
            // Mostra un caricamento temporaneo
            statusDot.classList.add('bg-yellow-400', 'animate-pulse');
            statusDot.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-400');
            statusText.textContent = 'Caricamento...';
            connectionStatus.classList.remove('bg-gray-100', 'text-gray-700');
            connectionStatus.classList.add('bg-gray-100', 'text-gray-500'); // Grigio chiaro testo
            
            currentOutingDocRef = doc(db, COLLECTION_NAME, docId);

            // onSnapshot si attiva la prima volta e poi ogni volta che i dati cambiano
            unsubscribeFirestore = onSnapshot(currentOutingDocRef, (docSnap) => {
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'Sincronizzato';
                connectionStatus.classList.remove('bg-gray-100', 'text-gray-500');
                connectionStatus.classList.add('bg-green-100', 'text-green-700');
                
                isUpdating = false; // Sblocca i clic

                if (docSnap.exists()) {
                    // Documento trovato, aggiorna la UI
                    updateVisuals(docSnap.data());
                } else {
                    // Documento non esiste (es. nuova data), crea un doc vuoto
                    console.log(`Nessun documento per ${docId}, ne creo uno nuovo.`);
                    const initialData = {
                        subject: '',
                        outingType: '',
                        attendance: {} // Inizia con presenze vuote
                    };
                    // Inizializza tutti gli studenti a 'false' (assente)
                    students.forEach(s => initialData.attendance[s.id] = false);
                    
                    setDoc(currentOutingDocRef, initialData);
                    // 'onSnapshot' si attiverà di nuovo automaticamente dopo setDoc,
                    // quindi non c'è bisogno di chiamare updateVisuals(initialData) qui.
                }
                
                // Nasconde l'overlay solo dopo il primo caricamento
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);

            }, (error) => {
                console.error("Errore listener Firestore:", error);
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'Errore';
                connectionStatus.classList.remove('bg-gray-100', 'text-gray-500');
                connectionStatus.classList.add('bg-red-100', 'text-red-700');
                isUpdating = false; // Sblocca in caso di errore
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
            });
        }
        
        /**
         * Gestore per il cambio data
         */
        function handleDateChange() {
            const dateValue = dateInput.value; // Formato YYYY-MM-DD
            if (dateValue) {
                // Se viene selezionata una data, avvia il listener
                attachFirestoreListener(dateValue);
            } else {
                // Se la data viene cancellata, resetta tutto
                if (unsubscribeFirestore) unsubscribeFirestore();
                updateVisuals({}); // Pulisce la UI
                currentOutingDocRef = null;
                
                // Reimposta lo stato a "Pronto"
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse', 'bg-green-500', 'bg-red-500');
                statusDot.classList.add('bg-gray-400');
                statusText.textContent = 'Pronto';
                connectionStatus.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
                connectionStatus.classList.add('bg-gray-100', 'text-gray-700');
            }
        }

        /**
         * Gestore evento per il click sul nome dello studente.
         * Invia l'aggiornamento a Firestore.
         * @param {Event} event 
         */
        async function togglePresence(event) {
            // Se stiamo già salvando un clic, ignora i clic successivi
            if (isUpdating) {
                console.log("Salvataggio in corso, attendere...");
                return;
            }
            // Se il documento non è pronto (data non inserita)
            if (!currentOutingDocRef) {
                // Aggiunge un feedback visivo
                const dateLabel = document.querySelector('label[for="outingDate"]');
                dateLabel.classList.add('text-red-600', 'font-bold');
                setTimeout(() => {
                    dateLabel.classList.remove('text-red-600', 'font-bold');
                }, 1500);
                return;
            }
            
            isUpdating = true; // Imposta il blocco

            const item = event.currentTarget;
            const id = item.dataset.id;
            
            // Leggiamo lo stato attuale dalla variabile globale
            const attendance = currentOutingData.attendance || {};
            const isCurrentlyPresent = attendance[id] === true;
            const newPresence = !isCurrentlyPresent;

            try {
                // Usa updateDoc con la "dot notation"
                const fieldToUpdate = `attendance.${id}`;
                
                // Aggiorna solo quel campo
                await updateDoc(currentOutingDocRef, {
                    [fieldToUpdate]: newPresence
                });
                // 'onSnapshot' riceverà l'aggiornamento e chiamerà updateVisuals,
                // sbloccando anche 'isUpdating = false'.
                
            } catch (e) {
                console.error("Errore nell'aggiornamento della presenza:", e);
                isUpdating = false; // Sblocca in caso di errore
            }
        }

        /**
         * Salva i metadata (Insegnamento, Tipo) dopo un breve ritardo
         * per evitare scritture multiple (debouncing).
         */
        function handleMetadataChange() {
            // Cancella il timer precedente
            clearTimeout(metadataSaveTimer);
            
            // Se il documento non è pronto, non fare nulla
            if (!currentOutingDocRef) {
                // Aggiunge un feedback visivo se si prova a scrivere senza data
                if(subjectInput.value.trim() || outingTypeInput.value.trim()) {
                    const dateLabel = document.querySelector('label[for="outingDate"]');
                    dateLabel.classList.add('text-red-600', 'font-bold');
                    setTimeout(() => {
                        dateLabel.classList.remove('text-red-600', 'font-bold');
                    }, 1500);
                }
                return;
            }
            
            // Imposta un nuovo timer
            metadataSaveTimer = setTimeout(async () => {
                try {
                    await updateDoc(currentOutingDocRef, {
                        subject: subjectInput.value.trim(),
                        outingType: outingTypeInput.value.trim()
                    });
                    console.log("Metadata salvati.");
                } catch (e) {
                    console.error("Errore salvataggio metadata:", e);
                }
            }, 1000); // Salva 1 secondo dopo l'ultima modifica
        }


        // --- Gestori Eventi Pulsanti ---

        // Filtra la lista mentre l'utente digita
        searchBar.addEventListener('input', filterList);

        // Chiude il modale
        closeModalButton.addEventListener('click', () => modal.close());

        // Pulsante AZZERA
        resetButton.addEventListener('click', () => {
            if (!currentOutingDocRef) {
                const dateLabel = document.querySelector('label[for="outingDate"]');
                dateLabel.classList.add('text-red-600', 'font-bold');
                setTimeout(() => {
                    dateLabel.classList.remove('text-red-600', 'font-bold');
                }, 1500);
                return;
            }
            modalTitle.textContent = 'Azzera Presenze';
            exportContent.classList.add('hidden');
            resetContent.classList.remove('hidden');
            modal.showModal();
        });
        
        // Pulsante CONFERMA RESET
        confirmResetButton.addEventListener('click', async () => {
            if (!currentOutingDocRef) return;

            // Crea un oggetto con tutti gli studenti a 'false'
            const resetAttendance = {};
            for (const student of students) {
                resetAttendance[student.id] = false;
            }

            try {
                // Aggiorna solo il campo 'attendance'
                await updateDoc(currentOutingDocRef, {
                    attendance: resetAttendance
                });
                console.log("Presenze azzerate con successo.");
            } catch (e) {
                console.error("Errore durante l'azzeramento:", e);
            }
            
            modal.close();
            // L'interfaccia si aggiornerà automaticamente grazie a onSnapshot
        });


        /**
         * (MODIFICA) Pulsante ESPORTA / CONDIVIDI
         * Usa l'API Web Share se disponibile, altrimenti usa il modale.
         */
        exportButton.addEventListener('click', async () => {
            if (!currentOutingDocRef) {
                const dateLabel = document.querySelector('label[for="outingDate"]');
                dateLabel.classList.add('text-red-600', 'font-bold');
                setTimeout(() => {
                    dateLabel.classList.remove('text-red-600', 'font-bold');
                }, 1500);
                return;
            }

            const attendance = currentOutingData.attendance || {};
            
            let presenti = [];
            let assenti = [];

            // Divide gli studenti in due liste
            for (const student of students) {
                if (attendance[student.id] === true) {
                    presenti.push(`- ${student.name} (ID: ${student.id})`);
                } else {
                    assenti.push(`- ${student.name} (ID: ${student.id})`);
                }
            }

            // Costruisce il testo
            const date = dateInput.value || 'Data non specificata';
            const subject = subjectInput.value || 'Non specificato';
            const outingType = outingTypeInput.value || 'Non specificata';
            
            let output = `--- REPORT PRESENZE ---\n`;
            output += `Data: ${date}\n`;
            output += `Insegnamento: ${subject}\n`;
            output += `Tipo Uscita: ${outingType}\n`;
            output += `--------------------------\n\n`;
            
            output += `PRESENTI (${presenti.length}):\n`;
            output += presenti.length > 0 ? presenti.join('\n') : '(Nessuno)\n';
            output += `\nASSENTI (${assenti.length}):\n`;
            output += assenti.length > 0 ? assenti.join('\n') : '(Nessuno)\n';
            
            
            // Prova a usare l'API di condivisione nativa
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Report Presenze - ${date}`,
                        text: output,
                    });
                    console.log('Report condiviso con successo.');
                } catch (err) {
                    console.error('Errore durante la condivisione:', err);
                }
            } else {
                // Fallback per browser desktop (mostra il modale)
                console.log('API Web Share non supportata, uso il modale.');
                exportTextArea.value = output;
                modalTitle.textContent = 'Esporta Lista Presenze';
                exportContent.classList.remove('hidden');
                resetContent.classList.add('hidden');
                modal.showModal();
            }
        });

        // Pulsante COPIA TESTO (usato solo nel fallback)
        copyButton.addEventListener('click', () => {
            exportTextArea.select();
            try {
                // document.execCommand è deprecato ma più affidabile in contesti non sicuri
                document.execCommand('copy');
                copyButton.textContent = 'Copiato!';
                setTimeout(() => { copyButton.textContent = 'Copia Testo'; }, 2000);
            } catch (err) {
                // Fallback per navigator.clipboard (richiede HTTPS)
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(exportTextArea.value).then(() => {
                        copyButton.textContent = 'Copiato!';
                        setTimeout(() => { copyButton.textContent = 'Copia Testo'; }, 2000);
                    }).catch(err => {
                        copyButton.textContent = 'Errore... Copia manualmente.';
                    });
                } else {
                    copyButton.textContent = 'Errore... Copia manualmente.';
                }
            }
        });
        
        /**
         * (FIX) Funzione che crea la griglia statica degli studenti
         * Viene chiamata UNA SOLA VOLTA.
         */
        function createStudentGrid() {
            studentGridContainer.innerHTML = ''; // Pulisce
            students.forEach(student => {
                const item = document.createElement('div');
                item.textContent = student.name;
                item.dataset.id = student.id; // Salva l'ID nell'elemento
                item.className = 'student-item'; // Stile base
                
                // (FIX) Applica lo stile "assente" di default
                item.classList.add('text-gray-900', 'bg-white', 'border-gray-300');
                
                // Aggiunge l'evento click per segnare/deselezionare
                item.addEventListener('click', togglePresence);
                
                studentGridContainer.appendChild(item);
            });
            // Aggiorna il contatore a 0
            counter.textContent = `Presenti: 0 / ${students.length}`;
        }
        
        // --- Avvio Applicazione ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // 1. Aggiungi i listener per i metadata
            subjectInput.addEventListener('input', handleMetadataChange);
            outingTypeInput.addEventListener('input', handleMetadataChange);
            // Il listener per la data si attiva quando si cambia giorno
            dateInput.addEventListener('change', handleDateChange);

            // 2. Inizializza Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 3. Gestisci l'autenticazione
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Utente già loggato (anonimo)
                        console.log("Utente autenticato, app in attesa.");
                        
                        // (MODIFICA) AVVIO "VUOTO"
                        // Imposta lo stato a "Pronto" (grigio)
                        statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                        statusDot.classList.add('bg-gray-400');
                        statusText.textContent = 'Pronto';
                        connectionStatus.classList.remove('bg-gray-100', 'text-gray-500');
                        connectionStatus.classList.add('bg-gray-100', 'text-gray-700');
                        
                        // 1. Crea la griglia (ora qui, dopo auth)
                        createStudentGrid(); 
                        
                        // 2. Rimuove il caricamento
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
                        
                        // 3. L'app ora attende che l'utente cambi la data in handleDateChange()
                        // (Nessuna chiamata automatica a handleDateChange() o set data)

                    } else {
                        // Utente non loggato, prova a fare login anonimo
                        try {
                            await signInAnonymously(auth);
                            console.log("Autenticazione anonima riuscita.");
                            // onAuthStateChanged si attiverà di nuovo,
                            // questa volta entrando nel blocco "if (user)"
                        } catch (e) {
                             console.error("Errore signInAnonymously:", e);
                             statusText.textContent = 'Errore Auth';
                             statusDot.classList.add('bg-red-500');
                             statusDot.classList.remove('animate-pulse');
                             
                             // Gestione errore 'auth/configuration-not-found'
                             if (e.code === 'auth/configuration-not-found') {
                                statusText.textContent = "Errore Auth: Abilita 'Accesso anonimo' in Firebase.";
                                alert("ERRORE: L'accesso anonimo non è abilitato.\n\nVai sulla tua Console Firebase -> Authentication -> Sign-in method e abilita 'Anonimo'.");
                             }
                        }
                    }
                });

            } catch (e) {
                console.error("Errore inizializzazione Firebase:", e);
                statusText.textContent = 'Errore Init.';
                statusDot.classList.add('bg-red-500');
                statusDot.classList.remove('animate-pulse');
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
            }
        });

    </script>
</body>
</html>
