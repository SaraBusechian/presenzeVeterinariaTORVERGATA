<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Presenze (Cloud Sync)</title>
    <!-- Caricamento di Tailwind CSS per lo stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile per un'interfaccia pulita */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overscroll-behavior: none; /* Impedisce il "bounce" su mobile */
        }
        
        /* Stile per gli elementi degli studenti */
        .student-item {
            -webkit-tap-highlight-color: transparent; /* Rimuove il flash blu al tocco su mobile */
            transition: all 0.15s ease-in-out;
            border: 1px solid #d1d5db; /* Bordo grigio */
            background-color: #ffffff; /* Sfondo bianco */
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            text-align: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .student-item:hover {
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }

        /* Stile per il backdrop del modal (per accessibilità) */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Stile per indicatore di stato connessione */
        #connectionStatus {
            transition: all 0.5s ease;
        }

        /* Stile per l'overlay di caricamento */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #f3f4f6; /* grigio chiaro */
            border-top-color: #3b82f6; /* blu */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stile per il PIN input */
        #pinInput {
            font-size: 2rem;
            letter-spacing: 0.5em;
            text-align: center;
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- Overlay di Caricamento Iniziale -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        
        <!-- Intestazione -->
        <header id="appHeader" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Registro Presenze</h1>
                    <p class="text-gray-600">Corso di Laurea in Medicina Veterinaria - Tor Vergata</p>
                </div>
                <!-- Indicatore di Stato Connessione -->
                <div id="connectionStatus" class="flex-shrink-0 flex items-center gap-2 bg-gray-100 text-gray-500 text-sm py-1 px-3 rounded-full">
                    <div id="statusDot" class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                    <span id="statusText">Connessione...</span>
                </div>
            </div>
            
            <!-- Campi Info Uscita -->
            <div class="mt-6 border-t pt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700">Insegnamento</label>
                    <input type="text" id="subject" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="outingDate" class="block text-sm font-medium text-gray-700">Data Uscita</label>
                    <input type="date" id="outingDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="outingType" class="block text-sm font-medium text-gray-700">Tipo Uscita (es. Stalla)</label>
                    <input type="text" id="outingType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </header>

        <!-- Pannello di Controllo -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <!-- Barra di Ricerca -->
            <input type="search" id="searchBar" placeholder="Cerca uno studente..." class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <!-- Contatore -->
            <div id="counter" class="text-lg font-semibold my-4 text-center text-gray-700">
                Presenti: 0 / 78
            </div>

            <!-- Pulsanti di Azione -->
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="exportButton" class="w-full sm:w-1/2 bg-blue-600 text-white py-3 px-4 rounded-lg shadow font-semibold hover:bg-blue-700 transition duration-200">
                    Esporta / Condividi
                </button>
                <button id="resetButton" class="w-full sm:w-1/2 bg-red-600 text-white py-3 px-4 rounded-lg shadow font-semibold hover:bg-red-700 transition duration-200">
                    Azzera Lista
                </button>
            </div>
        </div>

        <!-- Lista Studenti -->
        <main>
            <div id="studentGridContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- Gli studenti verranno caricati qui da JavaScript -->
            </div>
        </main>
    </div>

    <!-- Modale per Esportazione (Fallback per Desktop) / Conferma Reset -->
    <dialog id="modal" class="p-0 rounded-lg shadow-xl max-w-lg w-11/12">
        <div class="p-6">
            <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
            
            <!-- Contenuto per Esportazione (Fallback) -->
            <div id="exportContent">
                <p class="text-sm text-gray-600 mb-3">Copia e incolla questo testo in un'email, note o documento.</p>
                <textarea id="exportTextArea" readonly class="w-full h-48 p-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"></textarea>
                <button id="copyButton" class="mt-3 w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">Copia Testo</button>
            </div>
            
            <!-- Contenuto per Reset -->
            <div id="resetContent" class="hidden">
                <p class="text-gray-700">Sei sicuro di voler azzerare le presenze **solo per questo giorno**? Le informazioni (Insegnamento, Tipo) non verranno toccate.</p>
                <button id="confirmResetButton" class="mt-4 w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">Sì, Azzera Presenze</button>
            </div>
        </div>
        
        <!-- Pulsante di Chiusura Modale -->
        <footer class="bg-gray-100 p-4 text-right">
            <button id="closeModalButton" class="bg-gray-200 text-gray-800 py-2 px-5 rounded-lg hover:bg-gray-300">Chiudi</button>
        </footer>
    </dialog>
    
    <!-- (NOVITÀ) Modale per Inserimento PIN Matricola -->
    <dialog id="pinModal" class="p-0 rounded-lg shadow-xl max-w-sm w-11/12">
        <form method="dialog" id="pinForm">
            <div class="p-6">
                <h3 id="pinModalTitle" class="text-xl font-bold mb-2 text-center">Conferma Presenza</h3>
                <p id="pinStudentName" class="text-center text-gray-700 text-lg mb-4"></p>
                <label for="pinInput" class="block text-sm font-medium text-gray-700 text-center">Inserisci le **ultime 4 cifre** della tua matricola:</label>
                <input 
                    type="tel" 
                    id="pinInput" 
                    class="mt-2 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                    maxlength="4" 
                    pattern="\d{4}" 
                    inputmode="numeric" 
                    autocomplete="off"
                    required
                >
                <p id="pinError" class="text-red-600 text-sm text-center h-4 mt-2"></p>
            </div>
            
            <!-- Pulsanti di Azione Modale PIN -->
            <footer class="bg-gray-100 p-4 flex gap-3">
                <button id="pinCancelButton" type="button" class="w-1/2 bg-gray-200 text-gray-800 py-2 px-5 rounded-lg hover:bg-gray-300">
                    Annulla
                </button>
                <button id="pinConfirmButton" type="submit" class="w-1/2 bg-green-600 text-white py-2 px-5 rounded-lg hover:bg-green-700">
                    Conferma
                </button>
            </footer>
        </form>
    </dialog>


    <!-- Script per Firebase -->
    <script type="module">
        // Importa le funzioni necessarie dai moduli Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAZIONE ---
        
        // (MODIFICA) Lista studenti aggiornata con i dati reali (78 studenti)
        // L'ID è la MATRICOLA (come stringa, per preservare gli '0' iniziali)
        const students = [
            { id: '0361081', name: 'ABBATE MARIANGELA' },
            { id: '0357899', name: 'ACCHIONE MARIA' },
            { id: '0364914', name: 'ALBERTI VALENTINA' },
            { id: '0358281', name: 'AMBRIFI NIVES' },
            { id: '0357796', name: 'APONE JACOPO ARES' },
            { id: '0364953', name: 'ARNONE MARCELLA' },
            { id: '0358185', name: 'BARDELLI VALENTINA' },
            { id: '0345650', name: 'BARNI GIORDANO' },
            { id: '0360330', name: 'BARTOCCINI BENEDETTA' },
            { id: '0363927', name: 'BIRELLO ARIANNA' },
            { id: '0361033', name: 'BUCCHI FEDERICA' },
            { id: '0364891', name: 'CAMEO LORENZO' },
            { id: '0357819', name: 'CAPPARONI ALESSANDRO' },
            { id: '0364965', name: 'CAPREDONI GIULIA' },
            { id: '0357942', name: 'CARIA PRISCO' },
            { id: '0357820', name: 'CASSONI ELISA' },
            { id: '0357954', name: 'CASTELLITTO MADDALENA' },
            { id: '0359889', name: 'CATENA FEDERICA' },
            { id: '0357974', name: 'CELLI VIRGINIA' },
            { id: '0364083', name: 'CERRA MONICA' },
            { id: '0308693', name: 'CIFERRI CHIARA' },
            { id: '0366267', name: 'CIOFFI ALESSANDRA' },
            { id: '0357874', name: 'CIRILLO ALESSANDRA' },
            { id: '0363997', name: 'CONTE MARIAELENA' },
            { id: '0359922', name: 'CONTI TOMMASO' },
            { id: '0357840', name: 'COPPA MARTINA' },
            { id: '0362386', name: 'COSENTINO MARIANNA' },
            { id: '0358121', name: 'DAMIAN ELEONORA MARIA' },
            { id: '0359906', name: 'DE BARI MARIA ELISA' },
            { id: '0359862', name: 'DE DOMINICIS FEDERICA' },
            { id: '0357976', name: 'DELLE FRATTE VALENTINA' },
            { id: '0342153', name: 'DENTAMARO MAURO' },
            { id: '0358250', name: 'DI MANNO CAROLINA' },
            { id: '0342687', name: 'D\'OTTAVI ELEONORA' },
            { id: '0364557', name: 'FABBO LUCREZIA' },
            { id: '0363906', name: 'FALCONE ROSALIA' },
            { id: '0357836', name: 'FIAMMENGO ALICE' },
            { id: '0361370', name: 'FORCINITI GIOVANNA ANGELA' },
            { id: '0358325', name: 'GASPARINI CHIARA' },
            { id: '0361482', name: 'GIAMBELLUCA DILETTA' },
            { id: '0360070', name: 'IANNOTTA LIVIA' },
            { id: '0365377', name: 'INGA VANESSA' },
            { id: '0358091', name: 'LACELLI ARIANNA BARBARA' },
            { id: '0359734', name: 'LODOLI LUDOVICO' },
            { id: '0357806', name: 'LOSCO VALENTINA' },
            { id: '0359884', name: 'LUDOVISI CRISTINA' },
            { id: '0362347', name: 'MAGRINI ELOISA' },
            { id: '0358465', name: 'MARTINELLI DANIELE' },
            { id: '0357835', name: 'MARTUCCI MARCO' },
            { id: '0363376', name: 'MATTEUCCI CHIARA' },
            { id: '0359938', name: 'MEDERI GIULIA' },
            { id: '0358073', name: 'MOCHI EMANUELE' },
            { id: '0358169', name: 'MODESTI GRETA' },
            { id: '0358022', name: 'MOZZETTI EMANUELE' },
            { id: '0359932', name: 'NERI ALESSIA' },
            { id: '0358050', name: 'NESE ALICE' },
            { id: '0357894', name: 'PACELLI SOFIA' },
            { id: '0357805', name: 'PADOVANI BENEDETTA' },
            { id: '0357776', name: 'PALAZZI ALESSIA' },
            { id: '0364410', name: 'PALLANTE NICOLE' },
            { id: '0360667', name: 'PESAVENTO BEATRIZ' },
            { id: '0358051', name: 'PINCO CHIARA' },
            { id: '0359875', name: 'PIZZICANNELLA GIULIA' },
            { id: '0361405', name: 'PIZZOLITTO MARTINA' },
            { id: '0357914', name: 'PRILI ELEONORA' },
            { id: '0359776', name: 'RAGNI ILARIA' },
            { id: '0357882', name: 'RINALDI LORENZO' },
            { id: '0357846', name: 'RUFINI BENEDETTA' },
            { id: '0362402', name: 'RUSCELLONI BEATRICE' },
            { id: '0359924', name: 'SABINO NOEMI' },
            { id: '0358034', name: 'SALVATORI GEMMA' },
            { id: '0358201', name: 'SARGENTI SARA' },
            { id: '0312852', name: 'SCORZA ADELE PIA' },
            { id: '0358331', name: 'STROSCIA CHIARA' },
            { id: '0358142', name: 'TOLOMEI FRANCESCO' },
            { id: '0360218', name: 'VIANELLO VITTORIA' },
            { id: '0358302', name: 'VINCI ALICE' },
            { id: '0358146', name: 'ZAMPARINI LORENZO' }
        ];

        // --- CONFIGURAZIONE FIREBASE ---
        // Configurazione Firebase (inserita da te)
        const firebaseConfig = {
          apiKey: "AIzaSyAYgvLPFt9ZtfvnnwSebotXMbazOb-BcUs",
          authDomain: "presenze-pratiche-incampo-vet.firebaseapp.com",
          projectId: "presenze-pratiche-incampo-vet",
          storageBucket: "presenze-pratiche-incampo-vet.firebasestorage.app",
          messagingSenderId: "30237331152",
          appId: "1:30237331152:web:57d036de59d78108c198d5"
        };
        
        // Nome della collezione in Firestore (deve corrispondere alle Regole)
        const COLLECTION_NAME = "zootecnia_outings";


        // --- Variabili Globali ---
        let db; 
        let auth;
        let currentOutingDocRef; // Riferimento dinamico al documento dell'uscita
        let currentOutingData = {}; // Stato locale (aggiornato da Firestore)
        let unsubscribeFirestore; // Funzione per staccare il listener
        let isUpdating = false; // Flag per prevenire doppi clic
        let metadataSaveTimer; // Timer per salvare i metadata
        let currentStudentId = null; // (NOVITÀ) ID dello studente che sta inserendo il PIN
        const studentMap = new Map(students.map(s => [s.id, s.name])); // Mappa per lookup veloci

        // --- Elementi del DOM ---
        const studentGridContainer = document.getElementById('studentGridContainer');
        const searchBar = document.getElementById('searchBar');
        const counter = document.getElementById('counter');
        const exportButton = document.getElementById('exportButton');
        const resetButton = document.getElementById('resetButton');
        
        // Header
        const connectionStatus = document.getElementById('connectionStatus');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const subjectInput = document.getElementById('subject');
        const dateInput = document.getElementById('outingDate');
        const outingTypeInput = document.getElementById('outingType');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Modale (vecchio)
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const exportContent = document.getElementById('exportContent');
        const exportTextArea = document.getElementById('exportTextArea');
        const copyButton = document.getElementById('copyButton');
        const resetContent = document.getElementById('resetContent');
        const confirmResetButton = document.getElementById('confirmResetButton');
        const closeModalButton = document.getElementById('closeModalButton');
        
        // (NOVITÀ) Modale PIN
        const pinModal = document.getElementById('pinModal');
        const pinForm = document.getElementById('pinForm');
        const pinModalTitle = document.getElementById('pinModalTitle');
        const pinStudentName = document.getElementById('pinStudentName');
        const pinInput = document.getElementById('pinInput');
        const pinError = document.getElementById('pinError');
        const pinConfirmButton = document.getElementById('pinConfirmButton');
        const pinCancelButton = document.getElementById('pinCancelButton');


        // --- Funzioni Principali ---

        /**
         * Aggiorna solo gli stili (presente/assente) degli elementi
         * e il contatore, senza ricreare il DOM.
         */
        function updateVisuals(data = {}) {
            currentOutingData = data; // Aggiorna lo stato globale

            const attendance = currentOutingData.attendance || {};
            let presentCount = 0;
            
            // Aggiorna i campi metadata nell'header
            if (document.activeElement !== subjectInput) {
                subjectInput.value = currentOutingData.subject || '';
            }
            if (document.activeElement !== outingTypeInput) {
                outingTypeInput.value = currentOutingData.outingType || '';
            }

            // Itera su tutti gli elementi studente *già presenti* nel DOM
            const studentItems = studentGridContainer.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const id = item.dataset.id;
                const isPresent = attendance[id] === true;
                
                // Applica o rimuovi le classi Tailwind direttamente
                item.classList.toggle('text-gray-500', isPresent);
                item.classList.toggle('line-through', isPresent);
                item.classList.toggle('opacity-75', isPresent);
                item.classList.toggle('bg-gray-50', isPresent);
                item.classList.toggle('border-gray-200', isPresent);

                // Stili per "assente" (default)
                item.classList.toggle('text-gray-900', !isPresent);
                item.classList.toggle('bg-white', !isPresent);
                item.classList.toggle('border-gray-300', !isPresent);

                if (isPresent) {
                    presentCount++;
                }
            });

            // Aggiorna il contatore
            counter.textContent = `Presenti: ${presentCount} / ${students.length}`;
        }
        
        /**
         * Filtra la lista (mostra/nasconde) in base alla ricerca.
         * Non ricrea il DOM.
         */
        function filterList() {
            const normalizedFilter = searchBar.value.trim().toLowerCase();
            const studentItems = studentGridContainer.querySelectorAll('.student-item');

            studentItems.forEach(item => {
                const name = item.textContent.toLowerCase();
                const isMatch = name.includes(normalizedFilter);
                // Nasconde o mostra l'elemento
                item.style.display = isMatch ? 'block' : 'none';
            });
        }


        /**
         * Si collega a un documento specifico in Firestore in base alla data.
         * @param {string} docId - La data (es. "2025-11-15")
         */
        function attachFirestoreListener(docId) {
            // Se c'è un listener precedente, stacccalo per evitare ascolti multipli
            if (unsubscribeFirestore) {
                unsubscribeFirestore();
            }
            
            // Mostra un caricamento temporaneo
            statusDot.classList.add('bg-yellow-400', 'animate-pulse');
            statusDot.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-400');
            statusText.textContent = 'Caricamento...';
            connectionStatus.classList.remove('bg-gray-100', 'text-gray-700');
            connectionStatus.classList.add('bg-gray-100', 'text-gray-500'); // Grigio chiaro testo
            
            currentOutingDocRef = doc(db, COLLECTION_NAME, docId);

            // onSnapshot si attiva la prima volta e poi ogni volta che i dati cambiano
            unsubscribeFirestore = onSnapshot(currentOutingDocRef, (docSnap) => {
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'Sincronizzato';
                connectionStatus.classList.remove('bg-gray-100', 'text-gray-500');
                connectionStatus.classList.add('bg-green-100', 'text-green-700');
                
                isUpdating = false; // Sblocca i clic (per il PIN)

                if (docSnap.exists()) {
                    // Documento trovato, aggiorna la UI
                    updateVisuals(docSnap.data());
                } else {
                    // Documento non esiste (es. nuova data), crea un doc vuoto
                    console.log(`Nessun documento per ${docId}, ne creo uno nuovo.`);
                    const initialData = {
                        subject: '',
                        outingType: '',
                        attendance: {} // Inizia con presenze vuote
                    };
                    // Inizializza tutti gli studenti a 'false' (assente)
                    students.forEach(s => initialData.attendance[s.id] = false);
                    
                    setDoc(currentOutingDocRef, initialData);
                    // 'onSnapshot' si attiverà di nuovo automaticamente dopo setDoc,
                }
                
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);

            }, (error) => {
                console.error("Errore listener Firestore:", error);
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'Errore';
                connectionStatus.classList.remove('bg-gray-100', 'text-gray-500');
                connectionStatus.classList.add('bg-red-100', 'text-red-700');
                isUpdating = false; // Sblocca in caso di errore
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
            });
        }
        
        /**
         * Gestore per il cambio data
         */
        function handleDateChange() {
            const dateValue = dateInput.value; // Formato YYYY-MM-DD
            if (dateValue) {
                // Se viene selezionata una data, avvia il listener
                attachFirestoreListener(dateValue);
            } else {
                // Se la data viene cancellata, resetta tutto
                if (unsubscribeFirestore) unsubscribeFirestore();
                updateVisuals({}); // Pulisce la UI
                currentOutingDocRef = null;
                
                // Reimposta lo stato a "Pronto"
                statusDot.classList.remove('bg-yellow-400', 'animate-pulse', 'bg-green-500', 'bg-red-500');
                statusDot.classList.add('bg-gray-400');
                statusText.textContent = 'Pronto';
                connectionStatus.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
                connectionStatus.classList.add('bg-gray-100', 'text-gray-700');
            }
        }

        /**
         * (MODIFICA) Gestore evento per il click sul nome.
         * Ora apre il modale del PIN invece di salvare direttamente.
         * @param {Event} event 
         */
        function handleStudentClick(event) {
            // Se il documento non è pronto (data non inserita), avvisa
            if (!currentOutingDocRef) {
                const dateLabel = document.querySelector('label[for="outingDate"]');
                dateLabel.classList.add('text-red-600', 'font-bold');
                setTimeout(() => {
                    dateLabel.classList.remove('text-red-600', 'font-bold');
                }, 1500);
                return;
            }

            const item = event.currentTarget;
            currentStudentId = item.dataset.id; // Salva l'ID per il gestore del PIN
            const studentName = item.textContent;

            // Controlla lo stato attuale
            const attendance = currentOutingData.attendance || {};
            const isCurrentlyPresent = attendance[currentStudentId] === true;

            // Pulisci il modale precedente
            pinInput.value = '';
            pinError.textContent = '';
            pinInput.focus();

            // Configura e apri il modale
            pinModalTitle.textContent = isCurrentlyPresent ? 'Annulla Presenza' : 'Conferma Presenza';
            pinStudentName.textContent = studentName;
            pinModal.showModal();
            pinInput.focus(); // Focus sull'input
        }
        
        /**
         * (NOVITÀ) Gestore per la conferma del PIN
         */
        async function handlePinConfirm() {
            // Se stiamo già salvando un clic, ignora
            if (isUpdating) {
                console.log("Salvataggio in corso, attendere...");
                return;
            }

            const pin = pinInput.value;
            if (pin.length < 4) {
                pinError.textContent = "Inserisci 4 cifre.";
                return;
            }

            // Trova la matricola reale
            const student = students.find(s => s.id === currentStudentId);
            if (!student) {
                pinError.textContent = "Errore: Studente non trovato.";
                return;
            }

            const correctPin = student.id.slice(-4); // Ultime 4 cifre della matricola

            if (pin === correctPin) {
                // PIN CORRETTO
                isUpdating = true; // Imposta il blocco
                pinError.textContent = '';
                
                // Calcola il nuovo stato
                const attendance = currentOutingData.attendance || {};
                const isCurrentlyPresent = attendance[currentStudentId] === true;
                const newPresence = !isCurrentlyPresent;

                try {
                    // Aggiorna il database
                    const fieldToUpdate = `attendance.${currentStudentId}`;
                    await updateDoc(currentOutingDocRef, {
                        [fieldToUpdate]: newPresence
                    });
                    
                    // onSnapshot si occuperà di aggiornare la UI
                    // e reimpostare isUpdating = false.
                    
                } catch (e) {
                    console.error("Errore nell'aggiornamento della presenza:", e);
                    pinError.textContent = "Errore di salvataggio. Riprova.";
                    isUpdating = false; // Sblocca in caso di errore
                }
                
                pinModal.close(); // Chiudi il modale

            } else {
                // PIN ERRATO
                pinError.textContent = "PIN non corretto. Riprova.";
                pinInput.value = ''; // Pulisci
                pinInput.focus();
            }
        }


        /**
         * Salva i metadata (Insegnamento, Tipo) dopo un breve ritardo
         */
        function handleMetadataChange() {
            // Cancella il timer precedente
            clearTimeout(metadataSaveTimer);
            
            // Se il documento non è pronto, non fare nulla
            if (!currentOutingDocRef) {
                if(subjectInput.value.trim() || outingTypeInput.value.trim()) {
                    const dateLabel = document.querySelector('label[for="outingDate"]');
                    dateLabel.classList.add('text-red-600', 'font-bold');
                    setTimeout(() => {
                        dateLabel.classList.remove('text-red-600', 'font-bold');
                    }, 1500);
                }
                return;
            }
            
            // Imposta un nuovo timer
            metadataSaveTimer = setTimeout(async () => {
                try {
                    await updateDoc(currentOutingDocRef, {
                        subject: subjectInput.value.trim(),
                        outingType: outingTypeInput.value.trim()
                    });
                    console.log("Metadata salvati.");
                } catch (e) {
                    console.error("Errore salvataggio metadata:", e);
                }
            }, 1000); // Salva 1 secondo dopo l'ultima modifica
        }


        // --- Gestori Eventi Pulsanti ---

        // Filtra la lista mentre l'utente digita
        searchBar.addEventListener('input', filterList);

        // Chiude il modale (vecchio)
        closeModalButton.addEventListener('click', () => modal.close());
        
        // (NOVITÀ) Gestori Modale PIN
        pinCancelButton.addEventListener('click', () => {
            pinModal.close();
        });
        
        pinForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Impedisce il submit standard del form
            handlePinConfirm();
        });

        // Pulsante AZZERA
        resetButton.addEventListener('click', () => {
            if (!currentOutingDocRef) {
                const dateLabel = document.querySelector('label[for="outingDate"]');
                dateLabel.classList.add('text-red-600', 'font-bold');
                setTimeout(() => {
                    dateLabel.classList.remove('text-red-600', 'font-bold');
                }, 1500);
                return;
            }
            modalTitle.textContent = 'Azzera Presenze';
            exportContent.classList.add('hidden');
            resetContent.classList.remove('hidden');
            modal.showModal();
        });
        
        // Pulsante CONFERMA RESET
        confirmResetButton.addEventListener('click', async () => {
            if (!currentOutingDocRef) return;

            // Crea un oggetto con tutti gli studenti a 'false'
            const resetAttendance = {};
            for (const student of students) {
                resetAttendance[student.id] = false;
            }

            try {
                // Aggiorna solo il campo 'attendance'
                await updateDoc(currentOutingDocRef, {
                    attendance: resetAttendance
                });
                console.log("Presenze azzerate con successo.");
            } catch (e) {
                console.error("Errore durante l'azzeramento:", e);
            }
            
            modal.close();
            // L'interfaccia si aggiornerà automaticamente grazie a onSnapshot
        });


        /**
         * Pulsante ESPORTA / CONDIVIDI
         */
        exportButton.addEventListener('click', async () => {
            if (!currentOutingDocRef) {
                const dateLabel = document.querySelector('label[for="outingDate"]');
                dateLabel.classList.add('text-red-600', 'font-bold');
                setTimeout(() => {
                    dateLabel.classList.remove('text-red-600', 'font-bold');
                }, 1500);
                return;
            }

            const attendance = currentOutingData.attendance || {};
            
            let presenti = [];
            let assenti = [];

            // Divide gli studenti in due liste
            for (const student of students) {
                if (attendance[student.id] === true) {
                    presenti.push(`- ${student.name} (ID: ${student.id})`);
                } else {
                    assenti.push(`- ${student.name} (ID: ${student.id})`);
                }
            }

            // Costruisce il testo
            const date = dateInput.value || 'Data non specificata';
            const subject = subjectInput.value || 'Non specificato';
            const outingType = outingTypeInput.value || 'Non specificata';
            
            let output = `--- REPORT PRESENZE ---\n`;
            output += `Data: ${date}\n`;
            output += `Insegnamento: ${subject}\n`;
            output += `Tipo Uscita: ${outingType}\n`;
            output += `--------------------------\n\n`;
            
            output += `PRESENTI (${presenti.length}):\n`;
            output += presenti.length > 0 ? presenti.join('\n') : '(Nessuno)\n';
            output += `\nASSENTI (${assenti.length}):\n`;
            output += assenti.length > 0 ? assenti.join('\n') : '(Nessuno)\n';
            
            
            // Prova a usare l'API di condivisione nativa
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Report Presenze - ${date}`,
                        text: output,
                    });
                    console.log('Report condiviso con successo.');
                } catch (err) {
                    console.error('Errore durante la condivisione:', err);
                }
            } else {
                // Fallback per browser desktop (mostra il modale)
                console.log('API Web Share non supportata, uso il modale.');
                exportTextArea.value = output;
                modalTitle.textContent = 'Esporta Lista Presenze';
                exportContent.classList.remove('hidden');
                resetContent.classList.add('hidden');
                modal.showModal();
            }
        });

        // Pulsante COPIA TESTO (usato solo nel fallback)
        copyButton.addEventListener('click', () => {
            exportTextArea.select();
            // ... (logica di copia invariata)
            try {
                document.execCommand('copy');
                copyButton.textContent = 'Copiato!';
                setTimeout(() => { copyButton.textContent = 'Copia Testo'; }, 2000);
            } catch (err) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(exportTextArea.value).then(() => {
                        copyButton.textContent = 'Copiato!';
                        setTimeout(() => { copyButton.textContent = 'Copia Testo'; }, 2000);
                    }).catch(err => {
                        copyButton.textContent = 'Errore... Copia manualmente.';
                    });
                } else {
                    copyButton.textContent = 'Errore... Copia manualmente.';
                }
            }
        });
        
        /**
         * Funzione che crea la griglia statica degli studenti
         * Viene chiamata UNA SOLA VOLTA.
         */
        function createStudentGrid() {
            studentGridContainer.innerHTML = ''; // Pulisce
            students.forEach(student => {
                const item = document.createElement('div');
                item.textContent = student.name;
                item.dataset.id = student.id; // Salva l'ID (matricola)
                item.className = 'student-item'; // Stile base
                
                // Applica lo stile "assente" di default
                item.classList.add('text-gray-900', 'bg-white', 'border-gray-300');
                
                // (MODIFICA) Il clic ora apre il modale del PIN
                item.addEventListener('click', handleStudentClick);
                
                studentGridContainer.appendChild(item);
            });
            // Aggiorna il contatore (basato sulla lista appena caricata)
            counter.textContent = `Presenti: 0 / ${students.length}`;
        }
        
        // --- Avvio Applicazione ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // 1. Aggiungi i listener per i metadata
            subjectInput.addEventListener('input', handleMetadataChange);
            outingTypeInput.addEventListener('input', handleMetadataChange);
            // Il listener per la data si attiva quando si cambia giorno
            dateInput.addEventListener('change', handleDateChange);

            // 2. Inizializza Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 3. Gestisci l'autenticazione
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Utente già loggato (anonimo)
                        console.log("Utente autenticato, app in attesa.");
                        
                        // AVVIO "VUOTO"
                        statusDot.classList.remove('bg-yellow-400', 'animate-pulse');
                        statusDot.classList.add('bg-gray-400');
                        statusText.textContent = 'Pronto';
                        connectionStatus.classList.remove('bg-gray-100', 'text-gray-500');
                        connectionStatus.classList.add('bg-gray-100', 'text-gray-700');
                        
                        // 1. Crea la griglia
                        createStudentGrid(); 
                        
                        // 2. Rimuove il caricamento
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
                        
                        // 3. L'app ora attende che l'utente cambi la data

                    } else {
                        // Utente non loggato, prova a fare login anonimo
                        try {
                            await signInAnonymously(auth);
                            console.log("Autenticazione anonima riuscita.");
                            // onAuthStateChanged si attiverà di nuovo
                        } catch (e) {
                             console.error("Errore signInAnonymously:", e);
                             statusText.textContent = 'Errore Auth';
                             statusDot.classList.add('bg-red-500');
                             statusDot.classList.remove('animate-pulse');
                             
                             if (e.code === 'auth/configuration-not-found') {
                                statusText.textContent = "Errore Auth: Abilita 'Accesso anonimo' in Firebase.";
                                alert("ERRORE: L'accesso anonimo non è abilitato.\n\nVai sulla tua Console Firebase -> Authentication -> Sign-in method e abilita 'Anonimo'.");
                             }
                        }
                    }
                });

            } catch (e) {
                console.error("Errore inizializzazione Firebase:", e);
                statusText.textContent = 'Errore Init.';
                statusDot.classList.add('bg-red-500');
                statusDot.classList.remove('animate-pulse');
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
            }
        });

    </script>
</body>
</html>
